### マルチスレッドサーバーの課題仕様

#### 概要
この課題では、マルチスレッドを利用したチャットサーバーを実装します。クライアントはコマンドラインインターフェースを使用してチャットを行い、サーバーは複数のクライアントからの接続を管理し、メッセージをブロードキャストします。基本機能としてユーザー認証、メッセージ送受信、コマンドサポートを実装し、将来的に日本語対応を考慮します。

#### 開発環境
- OS: Windows 10 + WSL2 (Ubuntu 22.04.3 LTS)
- 言語: C言語

#### データ構造

```c
typedef struct {
    unsigned int sequence;                  // シーケンス番号
    unsigned int from_port;                 // 送信元ポート番号
    unsigned int to_port;                   // 宛先ポート番号
    unsigned short year;                    // 年
    unsigned char month;                    // 月
    unsigned char day;                      // 日
    unsigned char hour;                     // 時
    unsigned char minute;                   // 分
    unsigned char second;                   // 秒
    unsigned char millisecond;              // 10ミリ秒
    unsigned char from_ip[MAX_IP_LENGTH];   // 送信元IPアドレス
    unsigned char to_ip[MAX_IP_LENGTH];     // 宛先IPアドレス
    char from_user[MAX_USERNAME_LENGTH];    // 送信元ユーザ名
    char to_user[MAX_USERNAME_LENGTH];      // 宛先ユーザ名
    char text[MAX_MESSAGE_LENGTH];          // メッセージ本文
    char command[MAX_COMMAND_LENGTH];       // コマンド
} ChatMessage;
```

#### メッセージ履歴ファイル

- **ファイル名**: `chat_history.txt`
- **フォーマット**:
  ```
  [YYYY-MM-DD HH:MM:SS] from_user: message
  ```

#### 基本機能

1. **ユーザー認証**
    - ユーザーがサーバーに接続する際に、ユーザー名を入力して認証を行う。
    - 重複するユーザー名が存在しないようにサーバー側でチェックする。

2. **メッセージ送受信**
    - クライアントはテキストメッセージを入力し、サーバーを経由して他のクライアントに送信する。
    - 他のクライアントからのメッセージをリアルタイムで受信して表示する。

3. **コマンドサポート**
    - ユーザーがチャットを制御するためのコマンドを入力できるようにする（例: `/quit`で退出、`/list`で接続中のユーザー一覧を表示、`/history`でメッセージ履歴を表示）。

#### 追加機能のアイデア

1. **プライベートメッセージ**
    - 特定のユーザーにのみメッセージを送信する機能。
    - コマンド例: `/msg <username> <message>`。

2. **ユーザー通知**
    - 新しいユーザーが接続した時、またはユーザーが切断した時に全ユーザーに通知する。

3. **ファイル送信**
    - チャットを通じてファイルを送受信する機能（基本的なバイナリデータ転送）。
    - コマンド例: `/sendfile <filename>`。

#### ユーザーインターフェースの設計

1. **入力プロンプトのカスタマイズ**
    - ユーザー名を含むプロンプト（例: `[username] >`）を表示して、誰が入力しているかを明示する。

2. **メッセージフォーマット**
    - 送信者名、タイムスタンプを含むメッセージフォーマットを統一して表示。
    - 例: `[HH:MM:SS] <username>: message`

#### コマンド例と使用方法

- **接続時のユーザー名入力**
    ```
    Welcome to the chat server!
    Please enter your username: john_doe
    ```

- **チャットの終了**
    ```
    [john_doe] > /quit
    Goodbye!
    ```

- **ユーザーリストの表示**
    ```
    [john_doe] > /list
    Connected users:
    - john_doe
    - jane_doe
    - alice_smith
    ```

- **チャット履歴の表示**
    ```
    [john_doe] > /history
    [10:05:30] <john_doe>: Hello everyone!
    [10:05:45] <jane_doe>: Hi John!
    ```

- **プライベートメッセージ送信**
    ```
    [john_doe] > /msg jane_doe Hi Jane!
    ```

- **メッセージ送信**
    ```
    [john_doe] > Hello everyone!
    ```

#### コマンドの処理フロー

##### 接続時のユーザー名入力
1. クライアントがユーザー名を入力し、サーバーに送信。
2. サーバーがユーザー名をチェックし、重複がなければ接続を許可。
3. クライアントは接続が許可されたら、メッセージ送信を開始。

##### `/quit` コマンド
1. クライアントが `/quit` コマンドを入力。
2. コマンドを `ChatMessage` 構造体の `command` フィールドに格納。
3. サーバーに `ChatMessage` 構造体を送信。
4. サーバーが `/quit` コマンドを受信し、クライアントの接続を終了。
5. クライアントがサーバーからの接続終了を確認し、終了メッセージを表示してプログラムを終了。

##### `/list` コマンド
1. クライアントが `/list` コマンドを入力。
2. コマンドを `ChatMessage` 構造体の `command` フィールドに格納。
3. サーバーに `ChatMessage` 構造体を送信。
4. サーバーが `/list` コマンドを受信し、接続中の全ユーザー名のリストを生成。
5. サーバーがユーザーリストをクライアントに送信。
6. クライアントがユーザーリストを受信し、表示。

##### `/history` コマンド
1. クライアントが `/history` コマンドを入力。
2. コマンドを `ChatMessage` 構造体の `command` フィールドに格納。
3. サーバーに `ChatMessage` 構造体を送信。
4. サーバーが `/history` コマンドを受信し、セッション中のメッセージ履歴を取得。
5. サーバーがメッセージ履歴をクライアントに送信。
6. クライアントがメッセージ履歴を受信し、表示。

##### `/msg` コマンド
1. クライアントが `/msg <username> <message>` コマンドを入力。
2. コマンドを `ChatMessage` 構造体の `command` フィールドに格納し、`message` フィールドにメッセージ内容を格納。
3. サーバーに `ChatMessage` 構造体を送信。
4. サーバーが `/msg` コマンドを受信し、指定されたユーザーにメッセージを送信。
5. 送信先のクライアントがメッセージを受信し、表示。

##### メッセージ送信
1. クライアントがメッセージを入力。
2. メッセージを `Chat

Message` 構造体の `message` フィールドに格納。
3. サーバーに `ChatMessage` 構造体を送信。
4. サーバーがメッセージを受信し、他のすべてのクライアントにブロードキャスト。
5. 他のクライアントがメッセージを受信し、表示。

### 実装のポイント

1. **スレッドを使用してメッセージの送受信を並行処理する**。
2. **入力と出力を分離するために、入力用と出力用に別々のバッファを使用する**。
3. **非同期I/Oを利用して、ユーザーの入力待ち時間中もサーバーからのメッセージを受信できるようにする**。
4. **接続の切断や送信失敗などのエラーを適切に処理し、ユーザーにフィードバックを提供する**。

### サーバーでのデータ管理

- **ユーザーリスト**:
    - サーバーは接続中のユーザー名のリストを管理する。新しいクライアントが接続するたびにユーザー名をリストに追加し、切断時に削除する。

- **メッセージ履歴**:
    - サーバーはセッション中のメッセージ履歴を保存する。各メッセージをリストまたはバッファに追加し、`/history` コマンドが来た際に履歴を送信する。

### 今後の予定

1. **日本語対応**
2. **メッセージ履歴管理方法の改善**
3. **ユーザーごとに文字色を分ける**
4. **スレッドプールの実装**
5. **メモリプールの実装**